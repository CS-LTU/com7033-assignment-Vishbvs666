{% extends "base.html" %}
{% block title %}Assigned patients Â· StrokeCare{% endblock %}

{% block content %}
<div class="sc-admin-page">
  <div class="container sc-admin-shell py-4">

    <!-- Header -->
    <div class="d-flex align-items-start justify-content-between mb-3">
      <div>
        <h1 class="sc-page-title mb-1">Assigned patients</h1>
        <p class="sc-page-subtitle mb-0">
          Patients currently under your care as an HCP.
        </p>
      </div>
      <div class="text-end d-none d-md-block">
        <small class="text-muted d-block">Filter</small>
        <span class="fw-semibold">
          {% if risk_filter == 'high' %}
            High-risk only
          {% elif risk_filter == 'medium' %}
            Medium-risk only
          {% elif risk_filter == 'low' %}
            Low-risk only
          {% elif risk_filter == 'unknown' %}
            Unknown only
          {% else %}
            All patients
          {% endif %}
        </span>
      </div>
    </div>

    <!-- Search + risk filter -->
    <form class="row g-2 align-items-center mb-3" method="get">
      <div class="col-12 col-md-6">
        <label class="form-label small text-muted mb-1">Search</label>
        <input
          type="text"
          name="q"
          class="form-control sc-input"
          placeholder="ID, gender, work type, smoking status..."
          value="{{ search_query or '' }}"
        >
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label small text-muted mb-1">Risk filter</label>
        <select name="risk_filter" class="form-select sc-input">
          <option value="all" {% if risk_filter == 'all' %}selected{% endif %}>All</option>
          <option value="high" {% if risk_filter == 'high' %}selected{% endif %}>High</option>
          <option value="medium" {% if risk_filter == 'medium' %}selected{% endif %}>Medium</option>
          <option value="low" {% if risk_filter == 'low' %}selected{% endif %}>Low</option>
          <option value="unknown" {% if risk_filter == 'unknown' %}selected{% endif %}>Unknown</option>
        </select>
      </div>
      <div class="col-6 col-md-3 d-flex align-items-end justify-content-md-end">
        <button type="submit" class="btn sc-btn-gradient px-4">
          Apply filters
        </button>
      </div>
    </form>

    <!-- List -->
    <div class="sc-card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="fw-semibold small">
          Assigned patient list
        </div>
        <div class="d-flex align-items-center gap-2 small text-muted">
          <span>Showing {{ total_count }} records</span>
          <a
            href="{{ url_for('hcp.hcp_patient_new') }}"
            class="btn btn-sm btn-outline-secondary rounded-pill"
          >
            Add patient
          </a>
        </div>
      </div>

      {% if patients %}
        <div class="table-responsive">
          <table class="table align-middle mb-0 sc-table">
            <thead>
              <tr>
                <th scope="col">Patient</th>
                <th scope="col">Risk level</th>
                <th scope="col">Risk score</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in patients %}
                <tr>
                  <td>
                    <a href="{{ url_for('hcp.hcp_patient_detail', patient_id=p.id) }}">
                      {{ p.name or ('Patient ' ~ loop.index) }}
                    </a>
                    <div class="text-muted small">
                      {% if p.sex %}{{ p.sex }},{% endif %}
                      {% if p.age is not none %} age {{ p.age }}{% endif %}
                    </div>
                  </td>
                  <td>
                    {% set rl = p.risk_level or 'Unknown' %}
                    <span class="badge rounded-pill sc-risk-pill
                      {% if rl == 'High' %} bg-danger-subtle text-danger
                      {% elif rl == 'Medium' %} bg-warning-subtle text-warning
                      {% elif rl == 'Low' %} bg-success-subtle text-success
                      {% else %} bg-light text-muted{% endif %}">
                      {{ rl }}
                    </span>
                  </td>
                  <td>
                    {{ '%.2f'|format(p.risk_score or 0.0) }}
                  </td>
                  <td class="text-end">
                    <div class="d-inline-flex gap-2">
                      <a
                        href="{{ url_for('hcp.hcp_patient_detail', patient_id=p.id) }}"
                        class="btn btn-sm btn-outline-secondary rounded-pill"
                      >
                        View
                      </a>
                      <form
                        method="post"
                        action="{{ url_for('hcp.hcp_patient_delete', patient_id=p.id) }}"
                        onsubmit="return confirm('Are you sure you want to delete this patient?');"
                      >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button
                          type="submit"
                          class="btn btn-sm btn-outline-danger rounded-pill"
                        >
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="text-muted small mb-0">
          No patients match this filter. Try changing the risk filter or search term.
        </p>
      {% endif %}
    </div>

  </div>
</div>
{% endblock %}
